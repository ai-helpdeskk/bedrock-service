name: Bedrock Service CD

on:
  workflow_run:
    workflows: ["Bedrock Service CI"]
    branches: [main]
    types:
      - completed
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy Bedrock Service
    runs-on: [self-hosted]
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Verify kubectl access
      run: |
        kubectl cluster-info
        kubectl get nodes
    
    - name: Wait for infrastructure dependencies
      run: |
        echo "⏳ Waiting for infrastructure to be ready..."
        
        # Wait for namespace
        timeout 300 bash -c 'until kubectl get namespace bedrock-chat 2>/dev/null; do echo "Waiting for namespace..."; sleep 10; done'
        
        # Wait for AWS secrets (this service needs AWS credentials)
        timeout 300 bash -c 'until kubectl get secret aws-secrets -n bedrock-chat 2>/dev/null; do echo "Waiting for AWS secrets..."; sleep 10; done'
        
        echo "✅ Infrastructure dependencies verified!"
    
    - name: Get latest image tag
      id: get-image
      run: |
        IMAGE_TAG="ghcr.io/${{ github.repository_owner }}/bedrock-chat-bedrock-service:latest"
        echo "image-tag=$IMAGE_TAG" >> $GITHUB_OUTPUT
        echo "Using image: $IMAGE_TAG"
    
    - name: Update deployment manifests
      run: |
        cd k8s
        sed -i "s|image: ghcr.io/.*/bedrock-chat-bedrock-service:.*|image: ${{ steps.get-image.outputs.image-tag }}|g" deployment.yaml
        
        echo "Updated deployment.yaml:"
        grep "image:" deployment.yaml
    
    - name: Deploy Bedrock Service
      run: |
        echo "🚀 Deploying Bedrock Service to Kubernetes..."
        
        kubectl apply -f k8s/ -n bedrock-chat
        
        echo "⏳ Waiting for deployment rollout..."
        kubectl rollout status deployment/bedrock-service -n bedrock-chat --timeout=300s
        
        echo "✅ Bedrock Service deployed successfully!"
    
    - name: Verify deployment
      run: |
        echo "🔍 Verifying Bedrock Service deployment..."
        
        kubectl get pods -n bedrock-chat -l app=bedrock-service -o wide
        kubectl get service bedrock-service -n bedrock-chat
        kubectl logs -n bedrock-chat -l app=bedrock-service --tail=20
        
        kubectl run test-bedrock-service-$RANDOM --image=curlimages/curl --rm -i --restart=Never -n bedrock-chat -- \
          curl -f http://bedrock-service.bedrock-chat.svc.cluster.local:9000/health || echo "Health check completed"
        
        echo "✅ Bedrock Service verification completed!"
    
    - name: Deployment summary
      run: |
        echo "🎉 **Bedrock Service Deployment Successful!**"
        echo "🔧 **AWS Configuration**: Using organization secrets for AWS credentials"

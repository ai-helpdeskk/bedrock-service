name: Bedrock Service CD

on:
  workflow_run:
    workflows: ["Bedrock Service CI"]
    branches: [main]
    types:
      - completed
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy Bedrock Service
    runs-on: [self-hosted]
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Verify kubectl access
      run: |
        kubectl cluster-info
        kubectl get nodes

    - name: Wait for infrastructure dependencies
      run: |
        echo "⏳ Waiting for infrastructure to be ready..."

        # Wait for namespace
        timeout 300 bash -c 'until kubectl get namespace bedrock-chat-v2 2>/dev/null; do echo "Waiting for namespace..."; sleep 10; done'

        # Wait for AWS secrets
        timeout 300 bash -c 'until kubectl get secret app-secrets -n bedrock-chat-v2 2>/dev/null; do echo "Waiting for AWS secrets..."; sleep 10; done'

        echo "✅ Infrastructure dependencies verified!"

    - name: Update AWS secrets with organization secrets
      run: |
        echo "🔐 Updating AWS credentials from organization secrets..."

        # Update the app-secrets with AWS credentials from organization secrets
        kubectl create secret generic app-secrets \
          --from-literal=AWS_ACCESS_KEY_ID="${{ secrets.AWS_ACCESS_KEY }}" \
          --from-literal=AWS_SECRET_ACCESS_KEY="${{ secrets.AWS_SECRET_KEY }}" \
          -n bedrock-chat-v2 \
          --dry-run=client -o yaml | kubectl apply -f -

        echo "✅ AWS credentials updated successfully!"

    - name: Deploy Bedrock Service
      run: |
        echo "🚀 Deploying Bedrock Service to Kubernetes..."

        kubectl apply -f k8s/ -n bedrock-chat-v2

        echo "⏳ Waiting for deployment rollout..."
        kubectl rollout status deployment/bedrock-service -n bedrock-chat-v2 --timeout=300s

        echo "✅ Bedrock Service deployed successfully!"

    - name: Verify deployment
      run: |
        echo "🔍 Verifying Bedrock Service deployment..."

        kubectl get pods -n bedrock-chat-v2 -l app=bedrock-service -o wide
        kubectl get service bedrock-service -n bedrock-chat-v2
        kubectl logs -n bedrock-chat-v2 -l app=bedrock-service --tail=20

        kubectl run test-bedrock-service-$RANDOM --image=curlimages/curl --rm -i --restart=Never -n bedrock-chat-v2 -- \
          curl -f http://bedrock-service.bedrock-chat-v2.svc.cluster.local:9000/health || echo "Health check completed"

        echo "✅ Bedrock Service verification completed!"

    - name: Deployment summary
      run: |
        echo "🎉 **Bedrock Service Deployment Successful!**"
        echo "🔧 **AWS Configuration**: Using organization secrets for AWS credentials"
        echo "🏷️ **Image**: Using static image samitsinghhh/bedrock-service:v3"
